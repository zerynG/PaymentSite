{% extends "itcost/base_with_sidebar.html" %}

{% block title %}{% if calculation %}Редактирование расчета{% else %}Новый расчет стоимости{% endif %}{% endblock %}

{% block main_content %}
    <div class="card shadow-sm border-0">
        <div class="card-header bg-transparent border-bottom-0">
            <h5 class="mb-0">
                {% if calculation %}
                    Редактирование расчета: {{ calculation.project_name }}
                {% else %}
                    Новый расчет стоимости
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            <form method="post" id="calculation-form">
                {% csrf_token %}
                
                <!-- Основные поля -->
                <h6 class="mb-3">Основная информация</h6>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">{{ form.project_name.label }} *</label>
                        {{ form.project_name }}
                        {% for error in form.project_name.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.client_name.label }}</label>
                        {{ form.client_name }}
                        {% for error in form.client_name.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-12">
                        <label class="form-label">{{ form.project_brief.label }}</label>
                        {{ form.project_brief }}
                        {% for error in form.project_brief.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Источник данных НМА -->
                {% if form.nma_source %}
                <h6 class="mb-3">Источник данных НМА</h6>
                <div class="mb-4">
                    {% for choice in form.nma_source %}
                        <div class="form-check mb-2">
                            {{ choice.tag }}
                            <label class="form-check-label" for="{{ choice.id_for_label }}">
                                {{ choice.choice_label }}
                            </label>
                        </div>
                    {% endfor %}
                    
                    <div id="existing-nma-section" class="mt-3" style="display: none;">
                        <label class="form-label">{{ form.existing_nma.label }}</label>
                        {{ form.existing_nma }}
                    </div>
                    
                    <div id="new-nma-section" class="mt-3" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Создание новой формы НМА</h6>
                                {% if nma_form %}
                                    {% for field in nma_form %}
                                        <div class="mb-3">
                                            <label class="form-label">{{ field.label }}</label>
                                            {{ field }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Источник данных коммерческого предложения -->
                {% if form.commercial_source %}
                <h6 class="mb-3">Источник данных коммерческого предложения</h6>
                <div class="mb-4">
                    {% for choice in form.commercial_source %}
                        <div class="form-check mb-2">
                            {{ choice.tag }}
                            <label class="form-check-label" for="{{ choice.id_for_label }}">
                                {{ choice.choice_label }}
                            </label>
                        </div>
                    {% endfor %}
                    
                    <div id="existing-commercial-section" class="mt-3" style="display: none;">
                        <label class="form-label">{{ form.existing_commercial.label }}</label>
                        {{ form.existing_commercial }}
                    </div>
                    
                    <div id="new-commercial-section" class="mt-3" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Создание нового коммерческого предложения</h6>
                                {% if commercial_form %}
                                    {% for field in commercial_form %}
                                        <div class="mb-3">
                                            <label class="form-label">{{ field.label }}</label>
                                            {{ field }}
                                        </div>
                                    {% endfor %}
                                    {% if service_formset %}
                                        <h6 class="mt-4">Услуги</h6>
                                        {{ service_formset.management_form }}
                                        {% for form_item in service_formset %}
                                            <div class="service-item mb-3 p-3 border rounded">
                                                {% for field in form_item %}
                                                    {% if not field.is_hidden %}
                                                        <div class="mb-2">
                                                            <label class="form-label">{{ field.label }}</label>
                                                            {{ field }}
                                                        </div>
                                                    {% else %}
                                                        {{ field }}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Параметры расчета -->
                <h6 class="mb-3">Параметры расчета</h6>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">{{ form.estimated_hours.label }} *</label>
                        {{ form.estimated_hours }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.hourly_rate.label }} *</label>
                        {{ form.hourly_rate }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.infrastructure_cost.label }}</label>
                        {{ form.infrastructure_cost }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.other_expenses.label }}</label>
                        {{ form.other_expenses }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.management_overhead_percent.label }}</label>
                        {{ form.management_overhead_percent }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.risk_percent.label }}</label>
                        {{ form.risk_percent }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.profit_margin_percent.label }}</label>
                        {{ form.profit_margin_percent }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.asset_capitalization_percent.label }}</label>
                        {{ form.asset_capitalization_percent }}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">{{ form.commercial_markup_percent.label }}</label>
                        {{ form.commercial_markup_percent }}
                    </div>
                </div>

                {{ form.nma_cost }}
                {{ form.commercial_proposal }}

                <div class="d-flex justify-content-between">
                    <a href="{% url 'itcost:dashboard' %}" class="btn btn-secondary">Отмена</a>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Обработка выбора источника НМА
    const nmaSourceRadios = document.querySelectorAll('input[name="nma_source"]');
    const existingNmaSection = document.getElementById('existing-nma-section');
    const newNmaSection = document.getElementById('new-nma-section');
    
    function toggleNmaSections() {
        const selected = document.querySelector('input[name="nma_source"]:checked');
        if (selected) {
            if (selected.value === 'existing') {
                existingNmaSection.style.display = 'block';
                newNmaSection.style.display = 'none';
            } else if (selected.value === 'new') {
                existingNmaSection.style.display = 'none';
                newNmaSection.style.display = 'block';
            } else {
                existingNmaSection.style.display = 'none';
                newNmaSection.style.display = 'none';
            }
        }
    }
    
    nmaSourceRadios.forEach(radio => {
        radio.addEventListener('change', toggleNmaSections);
    });
    toggleNmaSections();
    
    // Обработка выбора источника коммерческого предложения
    const commercialSourceRadios = document.querySelectorAll('input[name="commercial_source"]');
    const existingCommercialSection = document.getElementById('existing-commercial-section');
    const newCommercialSection = document.getElementById('new-commercial-section');
    
    function toggleCommercialSections() {
        const selected = document.querySelector('input[name="commercial_source"]:checked');
        if (selected) {
            if (selected.value === 'existing') {
                existingCommercialSection.style.display = 'block';
                newCommercialSection.style.display = 'none';
            } else if (selected.value === 'new') {
                existingCommercialSection.style.display = 'none';
                newCommercialSection.style.display = 'block';
            } else {
                existingCommercialSection.style.display = 'none';
                newCommercialSection.style.display = 'none';
            }
        }
    }
    
    commercialSourceRadios.forEach(radio => {
        radio.addEventListener('change', toggleCommercialSections);
    });
    toggleCommercialSections();
});
</script>
{% endblock main_content %}

